<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PWA RTL Bootstrap App — With Dark Mode Toggle</title>

  <!-- Bootstrap RTL CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@100..900&family=Poppins&display=swap');
    body {
      font-family: 'Noto Sans Arabic', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background: var(--bs-body-bg, #fff);
      color: var(--bs-body-color, #000);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark-theme {
      background: #121212;
      color: #eee;
    }

    .page {
      padding: 1rem;
      padding-bottom: 90px;
    }

    /* Custom navbar replacement */
    .button-container {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      background-color: rgb(27, 133, 219);
      width: 290px;
      /* increased width to fit toggle */
      height: 40px;
      align-items: center;
      justify-content: space-around;
      border-radius: 10px;
      box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px,
        rgba(27, 133, 219, 0.5) 5px 10px 15px;
      z-index: 1100;
    }

    .button {
      outline: 0 !important;
      border: 0 !important;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      transition: all ease-in-out 0.3s;
      cursor: pointer;
      user-select: none;
    }

    .button:hover {
      transform: translateY(-3px);
    }

    .icon {
      font-size: 20px;
    }

    /* Toast wrapper */
    .toast-wrapper {
      position: fixed;
      top: 0.5rem;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100vw - 2rem);
      max-width: 820px;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
      pointer-events: none;
      padding: 0 1rem;
    }

    .toast-wrapper .toast {
      width: 100%;
      pointer-events: auto;
      border-radius: 0.5rem;
    }

    .fab {
      position: fixed;
      bottom: 78px;
      left: 18px;
      z-index: 1050;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: #fff;
      background: #0d6efd;
      border: none;
      box-shadow: 0 6px 18px rgba(13, 110, 253, 0.18);
      cursor: pointer;
    }

    /* Dark theme adjustments for navbar */
    body.dark-theme .button-container {
      background-color: #1e3a8a;
      /* darker blue */
      box-shadow:
        rgba(0, 0, 0, 0.75) 0px 5px 15px,
        rgba(30, 58, 138, 0.8) 5px 10px 15px;
    }

    body.dark-theme .button {
      color: #ddd;
    }

    body.dark-theme .button:hover {
      color: #fff;
    }
  </style>
</head>

<body>

  <div class="tab-content">
    <div id="home" class="tab-pane fade show active page" role="tabpanel">
      <h3>الرئيسية</h3>
      <p>مثال لصفحة رئيسية.</p>
      <button class="btn btn-success" onclick="window.showToast('عملية ناجحة', 'success')">نجاح</button>
      <button class="btn btn-danger" onclick="window.showToast('حدث خطأ', 'error')">خطأ</button>
      <button class="btn btn-info text-white"
        onclick="window.showToast('معلومة مهمة', 'info')">معلومة</button>
    </div>

    <div id="search" class="tab-pane fade page" role="tabpanel">
      <h3>بحث</h3>
      <p>محتوى البحث...</p>
      <button id="fabBtn" class="fab d-none" aria-label="إضافة"><i class="bi bi-plus-lg"></i></button>
    </div>

    <div id="settings" class="tab-pane fade page" role="tabpanel">
      <h3>الإعدادات</h3>
      <p>خيارات الإعداد.</p>
    </div>

    <div id="preferences" class="tab-pane fade page" role="tabpanel">
      <h3>التفضيلات</h3>
      <p>صفحة التفضيلات.</p>
    </div>
  </div>

  <!-- Custom navbar replacement -->
  <div class="button-container" role="tablist" aria-label="Navigation Buttons">
    <button class="button" aria-controls="home" aria-selected="true" role="tab" tabindex="0" title="الرئيسية">
      <svg class="icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em"
        width="1em" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M946.5 505L560.1 118.8l-25.9-25.9a31.5 31.5 0 0 0-44.4 0L77.5 505a63.9 63.9 0 0 0-18.8 46c.4 35.2 29.7 63.3 64.9 63.3h42.5V940h691.8V614.3h43.4c17.1 0 33.2-6.7 45.3-18.8a63.6 63.6 0 0 0 18.7-45.3c0-17-6.7-33.1-18.8-45.2zM568 868H456V664h112v204zm217.9-325.7V868H632V640c0-22.1-17.9-40-40-40H432c-22.1 0-40 17.9-40 40v228H238.1V542.3h-96l370-369.7 23.1 23.1L882 542.3h-96.1z">
        </path>
      </svg>
    </button>
    <button class="button" aria-controls="search" aria-selected="false" role="tab" tabindex="-1" title="بحث">
      <svg class="icon" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"
        height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </button>
    <button class="button" aria-controls="settings" aria-selected="false" role="tab" tabindex="-1" title="الإعدادات">
      <svg class="icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em"
        width="1em" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z">
        </path>
      </svg>
    </button>
    <button class="button" aria-controls="preferences" aria-selected="false" role="tab" tabindex="-1" title="التفضيلات">
      <svg class="icon" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
        stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
    </button>

    <!-- Dark mode toggle button -->
    <button id="darkModeToggle" class="button" title="تبديل الوضع الليلي" aria-pressed="false" role="switch">
      <svg id="darkModeIcon" class="icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
        height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
        <!-- moon icon by default -->
        <path d="M21.75 15.55a9 9 0 01-11.2-11.2 9.013 9.013 0 1011.2 11.2z"></path>
      </svg>
    </button>
  </div>

  <div id="toastWrapper" class="toast-wrapper" aria-live="polite" aria-atomic="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    window._toastQueue = window._toastQueue || [];
    window._toastReady = false;

    function initializeApp() {
      const toastWrapper = document.getElementById('toastWrapper');
      if (!toastWrapper) return;

      const tabs = {
        home: document.getElementById('home'),
        search: document.getElementById('search'),
        settings: document.getElementById('settings'),
        preferences: document.getElementById('preferences'),
      };

      const buttons = Array.from(document.querySelectorAll('.button-container .button:not(#darkModeToggle)'));

      function createToastElement(message, type) {
        const el = document.createElement('div');
        const bg = type === 'error' ? 'bg-danger text-white' : type === 'info' ? 'bg-info text-white' : 'bg-success text-white';
        el.className = `toast ${bg} border-0`;
        el.setAttribute('role', 'alert');
        el.setAttribute('aria-live', 'assertive');
        el.setAttribute('aria-atomic', 'true');
        el.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        return el;
      }

      window._realShowToast = function (message, type = 'success', delay = 4000) {
        if (!toastWrapper) { alert(message); return; }
        const el = createToastElement(message, type);
        toastWrapper.appendChild(el);

        if (window.bootstrap && typeof window.bootstrap.Toast === 'function') {
          try {
            const bsToast = new bootstrap.Toast(el, { delay });
            bsToast.show();
            el.addEventListener('hidden.bs.toast', () => el.remove());
            return;
          } catch (err) {
            console.warn('bootstrap.Toast threw, falling back:', err);
          }
        }

        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 10);
        setTimeout(() => el.remove(), delay + 250);
      };

      window._toastReady = true;
      if (Array.isArray(window._toastQueue) && window._toastQueue.length) {
        window._toastQueue.forEach(t => window._realShowToast(t.message, t.type, t.delay));
        window._toastQueue.length = 0;
      }

      function activateTab(tabId) {
        Object.entries(tabs).forEach(([id, el]) => {
          if (el) {
            if (id === tabId) {
              el.classList.add('show', 'active');
            } else {
              el.classList.remove('show', 'active');
            }
          }
        });
        buttons.forEach(btn => {
          if (btn.getAttribute('aria-controls') === tabId) {
            btn.setAttribute('aria-selected', 'true');
            btn.tabIndex = 0;
          } else {
            btn.setAttribute('aria-selected', 'false');
            btn.tabIndex = -1;
          }
        });

        const fabBtn = document.getElementById('fabBtn');
        if (fabBtn) {
          fabBtn.classList.toggle('d-none', tabId !== 'search');
        }
      }

      buttons.forEach(button => {
        button.addEventListener('click', () => {
          activateTab(button.getAttribute('aria-controls'));
        });
      });

      // Initialize first active tab
      activateTab('home');

      const fabBtn = document.getElementById('fabBtn');
      if (fabBtn) {
        fabBtn.addEventListener('click', () => window.showToast('زر الإضافة تم الضغط عليه', 'info'));
      }

      // Dark mode toggle
      const darkModeToggle = document.getElementById('darkModeToggle');
      const darkModeIcon = document.getElementById('darkModeIcon');

      function updateDarkModeIcon(isDark) {
        if (!darkModeIcon) return;
        // Moon icon for dark mode off, sun icon for dark mode on
        if (isDark) {
          darkModeIcon.innerHTML = `
            <path d="M12 3v1a7 7 0 0 1 0 14v1a8 8 0 0 0 0-16z" fill="currentColor"></path>
            <circle cx="12" cy="12" r="3" fill="currentColor"></circle>
          `;
          darkModeToggle.setAttribute('aria-pressed', 'true');
        } else {
          darkModeIcon.innerHTML = `
            <path d="M21.75 15.55a9 9 0 01-11.2-11.2 9.013 9.013 0 1011.2 11.2z"></path>
          `;
          darkModeToggle.setAttribute('aria-pressed', 'false');
        }
      }

      function setDarkTheme(enabled) {
        if (enabled) {
          document.body.classList.add('dark-theme');
        } else {
          document.body.classList.remove('dark-theme');
        }
        updateDarkModeIcon(enabled);
        localStorage.setItem('darkThemeEnabled', enabled ? '1' : '0');
      }

      darkModeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.contains('dark-theme');
        setDarkTheme(!isDark);
        window.showToast(`تم تبديل الوضع إلى ${!isDark ? 'الداكن' : 'الفاتح'}`, 'info');
      });

      // Load theme from localStorage
      const savedTheme = localStorage.getItem('darkThemeEnabled');
      setDarkTheme(savedTheme === '1');

      (function runOptionalTests() {
        const params = new URLSearchParams(location.search);
        if (params.get('test') !== '1') return;

        console.group('PWA App Self Tests');
        try {
          console.log('Test: buttons count', buttons.length);
          if (buttons.length === 0) throw new Error('No nav buttons found');

          window.showToast('اختبار: رسالة نجاح', 'success');
          console.log('Test: showToast queued/shown (check UI)');

          activateTab('search');
          const fabVisible = !(fabBtn && fabBtn.classList.contains('d-none'));
          console.log('Test: FAB visible after switching to search?', fabVisible);

          console.log('Self-tests completed (visual verification may be required)');
        } catch (tErr) {
          console.error('Self-test failed:', tErr);
        }
        console.groupEnd();
      })();
    }

    function waitForBootstrapReady(callback) {
      if (window.bootstrap && window.bootstrap.Toast) {
        callback();
      } else {
        const intervalId = setInterval(() => {
          if (window.bootstrap && window.bootstrap.Toast) {
            clearInterval(intervalId);
            callback();
          }
        }, 50);

        setTimeout(() => {
          clearInterval(intervalId);
          if (!(window.bootstrap && window.bootstrap.Toast)) {
            console.warn('Bootstrap not fully loaded after 3 seconds, initializing anyway.');
            callback();
          }
        }, 3000);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      waitForBootstrapReady(initializeApp);
    });

    window.showToast = function (message, type = 'success', delay = 4000) {
      if (!window._toastReady) {
        window._toastQueue.push({ message, type, delay });
        return;
      }
      window._realShowToast(message, type, delay);
    };
  </script>
</body>

</html>